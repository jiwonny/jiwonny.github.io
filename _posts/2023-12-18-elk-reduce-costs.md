---
categories: study 
title: "ELK 비용 절반으로 줄인 썰 🤑"
excerpt: "2023-12-18"
taxonomy: study
toc: true
toc_sticky: true
toc_label: 목차
tags:
    - ELK
    - infra
author_profile: true
---

3분기가 끝나갈 즈음, 팀 리더로부터 ELK 비용을 줄여달라는 요청을 받았다. 

올해 초에 hot node 용량이 99%에 달하면서, 로그들이 적재되지 않는 문제가 발생했었다.
급히 hot node 용량을 두 배로 늘려 해결했지만, 근본적인 문제를 해결하지 못한 탓에 다시 용량을 줄이지 못하고 있었다.
근본적인 문제를 해결하지 못한 채로 용량을 줄이게 도면 또 다시 로그가 적재되지 않는 문제가 발생할 것이 분명했다.
그렇게 ELK 용량은 두 배가 되었고 비용도 두 배가 된 상태로 약간은 방치(?)되어 있었다.

"ELK 비용 정리해야 하는데.." 라는 마음의 짐은 항상 짊어진 채로 몇개월이 지났다.
3분기가 끝나가며, 이제는 정말로 ELK 비용을 정리해야 할 때가 왔다는 팀 리더의 판단이 있었다.

그렇게 ELK 비용 정리를 시작하게 되었다.

https://www.elastic.co/kr/blog/top-5-ways-to-optimize-your-elastic-cloud-costs
elk에서 비용 정리하려면 권장사항이 있다고 한다.
1. 검색 가능한 스냅샷 및 데이터 티어를 사용하여 저장 공간 비용 최적화
2. 7.15 릴리즈 이상으로 업그레이드하여 데이터 전송 비용 절감
3. 올바른 하드웨어 프로필과 시스템 유형 사용
4. 자동 확장 정책 사용
5. 클라우드 월 요금 청구로 시작하여 최적의 구성 구축

여기서 몇 가지 조건은 이미 충족하고 있었다.
이 중 가장 시도해봄직한 것은 1번이었고, 그 효과도 가장 클 것이라 판단했다.

인덱스와 관련해서 몇가지 문제가 있었는데,
1. 'A' 목적으로 사용하는 인덱스(A 인덱스)들은 ILM 이 적용되어 있고, index template도 적절히 정리되어 있다. 하지만, ILM 정책이 인덱스를 사용하고 있는 패턴에 알맞게 적용되어 있는지 검토해보지 않았다.
2. 'B' 목적으로 사용하는 인덱스(B 인덱스)들은 쌓이기만 하고 있다. ILM이 적용되어 있지 않아 항상 hot node에만 쌓인다.

이 문제들을 해결하기 위해 
1. 이 두 가지 문제를 해결하기 위해 목적에 맞는 검색 패턴을 정의하고, ILM 정책을 새로 생성해야 했다.
2. 인덱스가 적용되어 있지 않은 과거 'B' 인덱스는 ILM 정책을 적용해 올바른 티어로 이동시켜야 했다.
3. 앞으로 생성되는 B 인덱스에 자동으로 ILM 정책이 적용되면 좋겠다.

## ILM 정책 검토
사전 지식 설명. (샤딩 개수도 공부 및 설명 필요)
데이터 티어.
그래서 결정한 ilm 정책은 무엇이었는지.

## A 인덱스에 새로운 ilm 정책을 적용
단순히 ilm 정책 변경
기존 인덱스들은 어떻게 이동하는지? (이미 롤오버 된 인덱스들은 어떻게 되는건지?)

## 과거 B 인덱스에 새로운 ilm 적용
과거 B 인덱스도 모두 hot node에 있어 올바른 티어로 이동시키기 위해 
ilm 을 적용

## 새로운 B 인덱스에 자동으로 ilm 적용
index template

## 롤오버 어떻게?

## 결과
- 비용 절감
- 인덱스 정책 통일
- 롤오버 (샤딩 수) 정책 통일



